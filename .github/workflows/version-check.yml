name: Version Check

on:
  # æ¯å¤© UTC 0ç‚¹ (åŒ—äº¬æ—¶é—´ 8ç‚¹) è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # PR æ—¶ä¹Ÿæ£€æŸ¥
  pull_request:
    branches:
      - master

jobs:
  check-clion-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check CLion version
        id: version-check
        run: |
          ./gradlew checkClionVersion
        continue-on-error: true

      - name: Create Issue if version is outdated
        if: steps.version-check.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ”” CLion æ–°ç‰ˆæœ¬å‘å¸ƒ - éœ€è¦æ›´æ–° untilBuild';
            const body = `æ£€æµ‹åˆ° CLion å‘å¸ƒäº†æ–°ç‰ˆæœ¬ï¼
            
            å½“å‰æ’ä»¶çš„ \`untilBuild\` é…ç½®å¯èƒ½å·²è¿‡æ—¶ã€‚
            
            ## æ“ä½œæ­¥éª¤
            
            1. è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬ï¼š
               \`\`\`bash
               ./gradlew updateUntilBuild
               \`\`\`
            
            2. æ£€æŸ¥ç”Ÿæˆçš„æ›´æ”¹
            
            3. æµ‹è¯•æ’ä»¶å…¼å®¹æ€§
            
            4. æäº¤å¹¶å‘å¸ƒæ–°ç‰ˆæœ¬
            
            ## è‡ªåŠ¨åŒ–ä¿¡æ¯
            - è§¦å‘æ—¶é—´: ${new Date().toISOString()}
            - Workflow: ${context.workflow}
            - Run ID: ${context.runId}
            `;
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ ‡é¢˜çš„ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['version-update']
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            
            if (existingIssue) {
              console.log('Already has an open issue for version update');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ğŸ”„ ç‰ˆæœ¬æ£€æŸ¥å†æ¬¡å¤±è´¥ (${new Date().toISOString()})\n\nè¯·å°½å¿«æ›´æ–°ç‰ˆæœ¬é…ç½®ã€‚`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['version-update', 'automated']
              });
            }

      - name: Fail if version check failed
        if: steps.version-check.outcome == 'failure'
        run: |
          echo "âŒ ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼è¯·æ›´æ–° untilBuild é…ç½®"
          exit 1
