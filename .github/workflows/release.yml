name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # åŒ¹é…çº¯æ•°å­—å’Œå°æ•°ç‚¹æ ¼å¼çš„ tagï¼Œå¦‚ 1.0.1

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Extract tag version
        id: extract_version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/}"
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Read plugin version from gradle.properties
        id: plugin_version
        run: |
          PLUGIN_VERSION=$(grep "^pluginVersion=" gradle.properties | cut -d'=' -f2)
          echo "plugin_version=$PLUGIN_VERSION" >> $GITHUB_OUTPUT
          echo "Plugin version from gradle.properties: $PLUGIN_VERSION"

      - name: Validate version match
        run: |
          TAG_VERSION="${{ steps.extract_version.outputs.tag_version }}"
          PLUGIN_VERSION="${{ steps.plugin_version.outputs.plugin_version }}"
          
          if [ "$TAG_VERSION" != "$PLUGIN_VERSION" ]; then
            echo "âŒ é”™è¯¯: Tag ç‰ˆæœ¬å· ($TAG_VERSION) ä¸Ž gradle.properties ä¸­çš„ç‰ˆæœ¬å· ($PLUGIN_VERSION) ä¸ä¸€è‡´ï¼"
            echo "è¯·ç¡®ä¿ gradle.properties ä¸­çš„ pluginVersion ä¸Ž tag ç‰ˆæœ¬å·ä¸€è‡´åŽå†æ¬¡æŽ¨é€ tagã€‚"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $TAG_VERSION"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Verify plugin
        run: ./gradlew verifyPlugin

      - name: Get plugin artifact name
        id: artifact_name
        run: |
          ARTIFACT_PATH=$(ls build/distributions/*.zip | head -n 1)
          ARTIFACT_NAME=$(basename "$ARTIFACT_PATH")
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Plugin artifact: $ARTIFACT_NAME"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.extract_version.outputs.tag_version }}"
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          cat > RELEASE_NOTES.md << EOF
          ## EGE JetBrains Plugin v${VERSION}
          
          ### åŠŸèƒ½ç‰¹æ€§
          - EGE å›¾å½¢åº“é¡¹ç›®å‘å¯¼æ”¯æŒ
          - CLion ä¸“å±žé›†æˆ
          - å¤šå¹³å°æ”¯æŒ (Windows, macOS, Linux)
          - æ”¯æŒ CLion 2023.3 - 2025.1 (æœ€æ–°ç‰ˆæœ¬)
          
          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ä¸‹æ–¹çš„æ’ä»¶æ–‡ä»¶ (\`${{ steps.artifact_name.outputs.artifact_name }}\`)
          2. åœ¨ CLion ä¸­æ‰“å¼€ Settings/Preferences â†’ Plugins
          3. ç‚¹å‡»é½¿è½®å›¾æ ‡ â†’ Install Plugin from Disk
          4. é€‰æ‹©ä¸‹è½½çš„æ’ä»¶æ–‡ä»¶å¹¶å®‰è£…
          5. é‡å¯ CLion
          
          ### ç³»ç»Ÿè¦æ±‚
          - CLion 2023.3 æˆ–æ›´é«˜ç‰ˆæœ¬
          - JDK 17 æˆ–æ›´é«˜ç‰ˆæœ¬
          EOF
          
          echo "Changelog generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.extract_version.outputs.tag_version }}
          body_path: RELEASE_NOTES.md
          files: |
            ${{ steps.artifact_name.outputs.artifact_path }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "ðŸŽ‰ Release ${{ steps.extract_version.outputs.tag_version }} åˆ›å»ºæˆåŠŸï¼"
          echo "ðŸ“¦ æ’ä»¶æ–‡ä»¶: ${{ steps.artifact_name.outputs.artifact_name }}"
          echo "ðŸ”— æŸ¥çœ‹ Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.extract_version.outputs.tag_version }}"
